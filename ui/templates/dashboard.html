{{ define "content" }}
<div class="h-full flex overflow-hidden">
    <!-- Compact Request List -->
    <div class="w-80 lg:w-96 border-r border-slate-800 bg-slate-900/30 flex flex-col shrink-0">
        <div class="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">History</span>
            <span id="request-count" class="text-xs font-mono text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700/50">
                {{ len .Requests }}
            </span>
        </div>
        <ul id="request-list" class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-slate-800/50">
            {{ range .Requests }}
                {{ template "request-item" . }}
            {{ end }}
        </ul>
    </div>

    <!-- Details Area -->
    <div class="flex-1 flex flex-col min-w-0 bg-slate-950">
        <!-- Endpoint Header -->
        <div class="p-4 border-b border-slate-800 flex items-center justify-between gap-4 bg-slate-900/20">
            <div class="flex items-center gap-4 min-w-0 flex-1">
                <a href="/" class="text-xs text-slate-500 hover:text-brand-400 transition-colors flex items-center gap-1.5 shrink-0" title="View all endpoints">
                    <i class="fas fa-arrow-left text-[10px]"></i>
                    <span>All</span>
                </a>
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <span class="text-xs text-slate-500 font-semibold whitespace-nowrap uppercase tracking-wider shrink-0">URL</span>
                    <code class="bg-slate-900 border border-slate-800 text-brand-400 px-3 py-1 rounded text-sm font-mono truncate select-all shadow-inner flex-1 min-w-0">https://{{ .Host }}/h/{{ .Endpoint.ID }}</code>
                    <button onclick="navigator.clipboard.writeText('https://{{ .Host }}/h/{{ .Endpoint.ID }}')" class="text-slate-500 hover:text-white transition-colors p-1.5 hover:bg-slate-800 rounded-md shrink-0">
                        <i class="fas fa-copy text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-3 whitespace-nowrap">
                {{ if .OtherEndpoints }}
                <div class="relative group">
                    <button class="text-xs font-bold text-slate-300 hover:text-white bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1.5">
                        <i class="fas fa-exchange-alt text-[10px]"></i>
                        Switch
                        <i class="fas fa-chevron-down text-[8px]"></i>
                    </button>
                    <div class="absolute right-0 mt-2 w-64 bg-slate-900 border border-slate-800 rounded-lg shadow-xl py-1 z-50 hidden group-hover:block">
                        {{ range .OtherEndpoints }}
                        <a href="/{{ .ID }}" class="block px-4 py-2 text-[10px] font-mono text-slate-400 hover:text-white hover:bg-slate-800 truncate">
                            {{ .ID }}
                        </a>
                        {{ end }}
                        <div class="border-t border-slate-800 mt-1 pt-1">
                            <a href="/" class="block px-4 py-2 text-[10px] text-brand-400 hover:text-brand-300 hover:bg-slate-800">
                                <i class="fas fa-plus text-[8px] mr-2"></i>Create New
                            </a>
                        </div>
                    </div>
                </div>
                {{ end }}
                <span class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    Live Stream
                </span>
                <button class="text-xs font-bold text-white bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded-lg transition-all active:scale-95 flex items-center gap-1.5 shadow-lg shadow-red-600/10"
                        hx-delete="/endpoint/{{ .Endpoint.ID }}"
                        hx-confirm="Are you sure you want to delete this webhook endpoint? All requests will be deleted."
                        hx-target="body"
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.xhr.status === 200) { window.location.href = '/'; }">
                    <i class="fas fa-trash-can text-[10px]"></i>
                    Delete
                </button>
            </div>
        </div>

        <!-- Request Detail Placeholder/Content -->
        <div id="request-detail" class="flex-1 overflow-hidden flex flex-col">
            {{ if .FirstRequest }}
                {{ template "request-detail" .FirstRequest }}
            {{ else }}
                <div class="flex-1 flex flex-col items-center justify-center text-slate-600 p-8 text-center bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900/50 to-transparent">
                    <div class="w-16 h-16 bg-slate-900 border border-slate-800 rounded-2xl flex items-center justify-center mb-6 text-slate-700 shadow-xl opacity-20">
                        <img src="/static/pipehook.svg" class="w-10 h-10 grayscale" alt="PipeHooks">
                    </div>
                    <p class="text-sm font-medium text-slate-500">Waiting for activity on endpoint...</p>
                    <p class="text-xs text-slate-600 mt-2">Send an HTTP request to the URL above to see it here.</p>
                </div>
            {{ end }}
        </div>
    </div>
</div>

<script>
    (function() {
        if (typeof saveEndpoint === 'function') {
            saveEndpoint('{{ .Endpoint.ID }}');
        }

        // WebSocket connection for real-time updates
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/{{ .Endpoint.ID }}`;
        const ws = new WebSocket(wsUrl);
        const requestList = document.getElementById('request-list');
        const requestCount = document.getElementById('request-count');

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'new-request') {
                // Create a temporary container to parse the HTML
                const temp = document.createElement('div');
                temp.innerHTML = data.payload;
                const newItem = temp.querySelector('li');

                if (newItem && requestList) {
                    requestList.insertBefore(newItem, requestList.firstChild);

                    // Process HTMX attributes on the new element
                    if (typeof htmx !== 'undefined') {
                        htmx.process(newItem);
                    }

                    // Update count
                    if (requestCount) {
                        const current = parseInt(requestCount.innerText) || 0;
                        requestCount.innerText = current + 1;
                    }
                }
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        ws.onclose = function() {
            // Attempt to reconnect after 3 seconds
            setTimeout(function() {
                location.reload();
            }, 3000);
        };
    })();
</script>
{{ end }}

{{ define "request-item" }}
<li class="group hover:bg-slate-800/40 cursor-pointer transition-all relative border-l-4 border-transparent active:bg-slate-800/60"
    onclick="document.querySelectorAll('#request-list li').forEach(el => el.classList.remove('bg-slate-800/50', 'border-brand-500', 'shadow-inner')); this.classList.add('bg-slate-800/50', 'border-brand-500', 'shadow-inner')">
    <div class="px-4 py-4 flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0 cursor-pointer"
             hx-get="/r/{{ .ID }}"
             hx-target="#request-detail"
             hx-swap="innerHTML">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold {{ if eq .Method "GET" }}text-emerald-500 bg-emerald-500/10 border-emerald-500/20{{ else }}text-brand-400 bg-brand-500/10 border-brand-500/20{{ end }} font-mono px-2 py-0.5 rounded border">{{ .Method }}</span>
                <span class="text-[10px] text-slate-500 font-mono tracking-tighter">{{ .CreatedAt.Format "15:04:05" }}</span>
            </div>
            <p class="text-sm text-slate-300 font-mono truncate group-hover:text-white transition-colors">{{ .Path }}</p>
            <p class="text-[10px] text-slate-600 font-mono mt-1.5 truncate">{{ .RemoteAddr }}</p>
        </div>
        <button class="opacity-0 group-hover:opacity-100 transition-opacity text-slate-600 hover:text-red-500 p-1.5 rounded hover:bg-slate-800/50"
                hx-delete="/r/{{ .ID }}"
                hx-confirm="Delete this request?"
                hx-target="closest li"
                hx-swap="outerHTML"
                hx-on::after-request="if(event.detail.xhr.status === 200) { this.closest('li').remove(); const count = document.getElementById('request-count'); if(count) { const current = parseInt(count.innerText) || 0; count.innerText = Math.max(0, current - 1); } }"
                onclick="event.stopPropagation();">
            <i class="fas fa-trash-can text-[10px]"></i>
        </button>
    </div>
</li>
{{ end }}
