{{ define "content" }}
<div id="dashboard-vue-app" class="h-full flex overflow-hidden">
    <!-- Compact Request List -->
    <div class="w-80 lg:w-96 border-r border-slate-800 bg-slate-900/30 flex flex-col shrink-0">
        <div class="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">History</span>
            <span id="request-count" class="text-xs font-mono text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700/50">
                {{ len .Requests }}
            </span>
        </div>
        <ul id="request-list" class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-slate-800/50">
            {{ range .Requests }}
                {{ template "request-item" . }}
            {{ end }}
        </ul>
    </div>

    <!-- Details Area -->
    <div class="flex-1 flex flex-col min-w-0 bg-slate-950">
        <!-- Endpoint Header -->
        <div id="endpoint-header" class="p-4 border-b border-slate-800 flex items-center justify-between gap-4 bg-slate-900/20" data-endpoint-id="{{ if .Endpoint }}{{ .Endpoint.ID }}{{ end }}">
            <div class="flex items-center gap-4 min-w-0 flex-1">
                <a href="/" class="text-xs text-slate-500 hover:text-brand-400 transition-colors flex items-center gap-1.5 shrink-0" title="View all endpoints">
                    <i class="fas fa-arrow-left text-[10px]"></i>
                    <span>All</span>
                </a>
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <span class="text-xs text-slate-500 font-semibold whitespace-nowrap uppercase tracking-wider shrink-0">URL</span>
                    {{ if .Endpoint }}
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <div id="endpoint-color-dot" class="w-2 h-2 rounded-full shrink-0 bg-brand-500"></div>
                        <code id="endpoint-url" class="bg-slate-900 border border-slate-800 text-brand-400 px-3 py-1 rounded text-sm font-mono truncate select-all shadow-inner flex-1 min-w-0" data-url="https://{{ .Host }}/h/{{ .Endpoint.ID }}">https://{{ .Host }}/h/{{ .Endpoint.ID }}</code>
                    </div>
                    <button onclick="copyEndpointUrl()" class="text-slate-500 hover:text-white transition-colors p-1.5 hover:bg-slate-800 rounded-md shrink-0">
                        <i class="fas fa-copy text-xs"></i>
                    </button>
                    {{ else }}
                    <code class="bg-slate-900 border border-slate-800 text-slate-500 px-3 py-1 rounded text-sm font-mono truncate select-all shadow-inner flex-1 min-w-0">Loading...</code>
                    {{ end }}
                </div>
            </div>
            <div class="flex items-center gap-3 whitespace-nowrap">
                {{ if .OtherEndpoints }}
                <div class="relative" id="switch-container">
                    <button @click="toggleSwitchDropdown" class="text-xs font-bold text-slate-300 hover:text-white bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1.5">
                        <i class="fas fa-exchange-alt text-[10px]"></i>
                        Switch
                        <i class="fas fa-chevron-down text-[8px]" :class="{ 'rotate-180': switchDropdownOpen }"></i>
                    </button>
                    <transition name="dropdown">
                        <div v-if="switchDropdownOpen" class="absolute right-0 mt-2 w-64 bg-slate-900 border border-slate-800 rounded-lg shadow-xl py-1 z-50">
                        {{ range .OtherEndpoints }}
                        <a href="/{{ .ID }}" class="block px-4 py-2 text-[10px] font-mono text-slate-400 hover:text-white hover:bg-slate-800 truncate flex items-center gap-2 border-l-4 switch-endpoint-item" data-endpoint-id="{{ .ID }}">
                            <div class="w-1.5 h-1.5 rounded-full shrink-0 switch-endpoint-dot" data-endpoint-id="{{ .ID }}"></div>
                            <span class="truncate">{{ .ID }}</span>
                        </a>
                        {{ end }}
                        <div class="border-t border-slate-800 mt-1 pt-1">
                            <a href="/" class="block px-4 py-2 text-[10px] text-brand-400 hover:text-brand-300 hover:bg-slate-800">
                                <i class="fas fa-plus text-[8px] mr-2"></i>Create New
                            </a>
                        </div>
                        </div>
                    </transition>
                </div>
                {{ end }}
                <span class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    Live Stream
                </span>
                {{ if .Endpoint }}
                <button class="text-xs font-bold text-white bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded-lg transition-all active:scale-95 flex items-center gap-1.5 shadow-lg shadow-red-600/10"
                        hx-delete="/endpoint/{{ .Endpoint.ID }}"
                        hx-confirm="Are you sure you want to delete this webhook endpoint? All requests will be deleted."
                        hx-target="body"
                        hx-swap="none"
                        hx-on::after-request="handleDeleteEndpoint(this)">
                    <i class="fas fa-trash-can text-[10px]"></i>
                    Delete
                </button>
                {{ end }}
            </div>
        </div>

        <!-- Request Detail Placeholder/Content -->
        <div id="request-detail" class="flex-1 overflow-hidden flex flex-col relative transition-opacity duration-150">
            <!-- Loading overlay with Vue transition -->
            <transition name="fade">
                <div v-if="isLoading" class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm z-10 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-8 h-8 border-2 border-brand-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                        <p class="text-xs text-slate-400">Loading...</p>
                    </div>
                </div>
            </transition>
            <!-- Content wrapper -->
            <div id="request-detail-content" class="flex-1 overflow-hidden flex flex-col transition-opacity duration-200 ease-in-out">
                {{ if .FirstRequest }}
                    {{ template "request-detail" .FirstRequest }}
                {{ else }}
                    <div class="flex-1 flex flex-col items-center justify-center text-slate-600 p-8 text-center bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900/50 to-transparent">
                        <div class="w-16 h-16 bg-slate-900 border border-slate-800 rounded-2xl flex items-center justify-center mb-6 text-slate-700 shadow-xl opacity-20">
                            <img src="/static/pipehook.svg" class="w-10 h-10 grayscale" alt="PipeHooks">
                        </div>
                        <p class="text-sm font-medium text-slate-500">Waiting for activity on endpoint...</p>
                        <p class="text-xs text-slate-600 mt-2">Send an HTTP request to the URL above to see it here.</p>
                    </div>
                {{ end }}
            </div>
        </div>
    </div>
</div>

    <script>
        (function() {
            const { createApp } = Vue;

            // Vue app for dashboard interactions
            const dashboardApp = createApp({
                data() {
                    return {
                        isLoading: false,
                        selectedRequestId: null,
                        switchDropdownOpen: false,
                        endpointColor: null
                    }
                },
                mounted() {
                    // Set endpoint color on mount and apply to header
                    {{ if .Endpoint }}
                    const endpointIdElement = document.getElementById('endpoint-header');
                    if(endpointIdElement && typeof getEndpointColor === 'function') {
                        const endpointId = endpointIdElement.getAttribute('data-endpoint-id');
                        if(endpointId) {
                            this.endpointColor = getEndpointColor(endpointId);
                            if (this.endpointColor) {
                        const header = document.getElementById('endpoint-header');
                        const dot = document.getElementById('endpoint-color-dot');
                        const url = document.getElementById('endpoint-url');
                        if (header) {
                            header.classList.add('border-l-4', this.endpointColor.border);
                            header.classList.remove('border-slate-800');
                        }
                        if (dot) {
                            dot.classList.remove('bg-brand-500');
                            dot.classList.add(this.endpointColor.accent);
                        }
                        if (url) {
                            url.classList.remove('text-brand-400');
                            url.classList.add(this.endpointColor.text);
                        }
                    }
                    }
                    {{ end }}
                },
                methods: {
                    handleRequestClick(element) {
                        const requestId = element ? element.getAttribute('data-request-id') : null;
                        if(requestId) {
                            this.selectedRequestId = parseInt(requestId);
                            this.isLoading = true;
                        }
                    },
                    handleRequestLoaded() {
                        this.isLoading = false;
                    },
                    toggleSwitchDropdown() {
                        this.switchDropdownOpen = !this.switchDropdownOpen;
                    },
                    closeSwitchDropdown(event) {
                        const container = document.getElementById('switch-container');
                        if (container && !container.contains(event.target)) {
                            this.switchDropdownOpen = false;
                        }
                    }
                },
                mounted() {
                    // Close dropdown when clicking outside
                    document.addEventListener('click', this.closeSwitchDropdown);

                    // Handle HTMX events for smooth transitions
                    const self = this;
                    document.body.addEventListener('htmx:beforeRequest', function(e) {
                        if (e.detail.target && e.detail.target.id === 'request-detail-content') {
                            self.isLoading = true;
                            const content = document.getElementById('request-detail-content');
                            if (content) {
                                content.style.opacity = '0.4';
                            }
                            // Extract request ID from the URL
                            const url = e.detail.pathInfo ? e.detail.pathInfo.requestPath : e.detail.requestURL || '';
                            const match = url.match(/\/r\/(\d+)/);
                            if (match) {
                                self.selectedRequestId = parseInt(match[1]);
                            }
                        }
                    });

                    document.body.addEventListener('htmx:afterSwap', function(e) {
                        if (e.detail.target && e.detail.target.id === 'request-detail-content') {
                            setTimeout(() => {
                                self.isLoading = false;
                                const content = document.getElementById('request-detail-content');
                                if (content) {
                                    content.style.opacity = '1';
                                }
                            }, 150);

                            // Execute scripts from swapped content (extract from data attribute to avoid Vue compilation issues)
                            const scriptContainer = e.detail.target.querySelector('[data-request-detail-script]');
                            if (scriptContainer) {
                                const scriptTag = scriptContainer.querySelector('script[type="text/plain"]');
                                if (scriptTag) {
                                    const scriptContent = scriptTag.textContent || scriptTag.innerText;
                                    try {
                                        // Create and execute script in global scope
                                        const script = document.createElement('script');
                                        script.textContent = scriptContent;
                                        document.body.appendChild(script);
                                        document.body.removeChild(script);
                                    } catch (err) {
                                        console.error('Error executing request detail script:', err);
                                    }
                                }
                            }
                        }
                    });
                },
                beforeUnmount() {
                    document.removeEventListener('click', this.closeSwitchDropdown);
                }
            });

            // Copy endpoint URL function
            function copyEndpointUrl() {
                const urlElement = document.getElementById('endpoint-url');
                if(urlElement) {
                    const url = urlElement.getAttribute('data-url');
                    if(url) {
                        navigator.clipboard.writeText(url).then(() => {
                            if(typeof showToast === 'function') {
                                showToast('URL copied', 'success');
                            }
                        }).catch(() => {});
                    }
                }
            }
            window.copyEndpointUrl = copyEndpointUrl;

            // Handle delete endpoint
            function handleDeleteEndpoint(button) {
                if(typeof event !== 'undefined' && event.detail && event.detail.xhr && event.detail.xhr.status === 200) {
                    window.location.href = '/';
                }
            }
            window.handleDeleteEndpoint = handleDeleteEndpoint;

            // Mount Vue app
            dashboardApp.mount('#dashboard-vue-app');

            // Handle request item click
            function handleRequestItemClick(element) {
                // Remove active state from all items
                document.querySelectorAll('#request-list li').forEach(el => {
                    el.classList.remove('bg-slate-800/50', 'shadow-inner');
                });
                // Add active state to clicked item
                element.classList.add('bg-slate-800/50', 'shadow-inner');
                // Apply endpoint color if not already applied
                const endpointId = element.getAttribute('data-endpoint-id');
                if(endpointId && typeof getEndpointColor === 'function') {
                    const color = getEndpointColor(endpointId);
                    if(color && element.dataset.endpointColorBorder === '') {
                        element.classList.add(color.border);
                        element.dataset.endpointColorBorder = color.border;
                    }
                }
            }
            window.handleRequestItemClick = handleRequestItemClick;

            // Handle delete request from list
            function handleDeleteRequestFromList(button) {
                if(typeof event !== 'undefined' && event.detail && event.detail.xhr && event.detail.xhr.status === 200) {
                    const listItem = button.closest('li');
                    if(listItem) {
                        listItem.remove();
                        const count = document.getElementById('request-count');
                        if(count) {
                            const current = parseInt(count.innerText) || 0;
                            count.innerText = Math.max(0, current - 1);
                        }
                    }
                }
            }
            window.handleDeleteRequestFromList = handleDeleteRequestFromList;

            // Apply colors to request items and dropdown after Vue is mounted
            function applyEndpointColors() {
                document.querySelectorAll('[data-endpoint-id]').forEach(el => {
                    const endpointId = el.getAttribute('data-endpoint-id');
                    if (endpointId) {
                        const color = getEndpointColor(endpointId);
                        if (color) {
                            // Apply border color to list item
                            if (el.tagName === 'LI') {
                                el.classList.add(color.border);
                            }
                            // Apply border color to dropdown items
                            if (el.classList.contains('switch-endpoint-item')) {
                                el.classList.add(color.border);
                            }
                            // Apply dot color
                            const dot = el.querySelector('.endpoint-color-dot[data-endpoint-id="' + endpointId + '"]') ||
                                       el.querySelector('.switch-endpoint-dot[data-endpoint-id="' + endpointId + '"]');
                            if (dot) {
                                dot.classList.add(color.accent);
                            }
                        }
                    }
                });
            }

            setTimeout(applyEndpointColors, 100);

            // Re-apply colors when dropdown opens (for dynamically added items)
            document.body.addEventListener('htmx:afterSwap', function() {
                setTimeout(applyEndpointColors, 50);
            });

            if (typeof saveEndpoint === 'function') {
                saveEndpoint('{{ .Endpoint.ID }}');
            }

            // WebSocket connection for real-time updates
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/{{ .Endpoint.ID }}`;
            const ws = new WebSocket(wsUrl);
            const requestList = document.getElementById('request-list');
            const requestCount = document.getElementById('request-count');

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'new-request') {
                    // Create a temporary container to parse the HTML
                    const temp = document.createElement('div');
                    temp.innerHTML = data.payload;
                    const newItem = temp.querySelector('li');

                    if (newItem && requestList) {
                        requestList.insertBefore(newItem, requestList.firstChild);

                        // Process HTMX attributes on the new element
                        if (typeof htmx !== 'undefined') {
                            htmx.process(newItem);
                        }

                        // Update count
                        if (requestCount) {
                            const current = parseInt(requestCount.innerText) || 0;
                            requestCount.innerText = current + 1;
                        }

                        // Update relative times for the new item
                        if (typeof updateRelativeTimes === 'function') {
                            updateRelativeTimes();
                        }
                    }
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                // Connection closed - user can manually refresh if needed
                console.log('WebSocket connection closed');
            };
        })();
    </script>
{{ end }}

{{ define "request-item" }}
<li class="group hover:bg-slate-800/40 cursor-pointer transition-all relative border-l-4 active:bg-slate-800/60"
    data-request-id="{{ .ID }}"
    data-endpoint-id="{{ .EndpointID }}"
    data-endpoint-color-border=""
    onclick="handleRequestItemClick(this)">
    <div class="px-4 py-4 flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0 cursor-pointer"
             hx-get="/r/{{ .ID }}"
             hx-target="#request-detail-content"
             hx-swap="innerHTML"
             data-request-id="{{ .ID }}"
             onclick="handleRequestClick(this)">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-1.5">
                    <div class="endpoint-color-dot w-1.5 h-1.5 rounded-full shrink-0" data-endpoint-id="{{ .EndpointID }}"></div>
                    <span class="text-xs font-bold {{ if eq .Method "GET" }}text-emerald-500 bg-emerald-500/10 border-emerald-500/20{{ else }}text-brand-400 bg-brand-500/10 border-brand-500/20{{ end }} font-mono px-2 py-0.5 rounded border">{{ .Method }}</span>
                </div>
                <span class="text-[10px] text-slate-500 font-mono tracking-tighter" data-timestamp="{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}">{{ .CreatedAt.Format "15:04:05" }}</span>
            </div>
            <p class="text-sm text-slate-300 font-mono truncate group-hover:text-white transition-colors">{{ .Path }}</p>
            <p class="text-[10px] text-slate-600 font-mono mt-1.5 truncate">{{ .RemoteAddr }}</p>
        </div>
        <button class="opacity-0 group-hover:opacity-100 transition-opacity text-slate-600 hover:text-red-500 p-1.5 rounded hover:bg-slate-800/50"
                hx-delete="/r/{{ .ID }}"
                hx-target="closest li"
                hx-swap="outerHTML"
                hx-on::after-request="handleDeleteRequestFromList(this)"
                onclick="event.stopPropagation();">
            <i class="fas fa-trash-can text-[10px]"></i>
        </button>
    </div>
</li>
{{ end }}
