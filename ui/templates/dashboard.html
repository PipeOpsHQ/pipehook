{{ define "content" }}
<div class="h-full flex overflow-hidden">
    <!-- Compact Request List -->
    <div class="w-80 lg:w-96 border-r border-slate-800 bg-slate-900/30 flex flex-col shrink-0">
        <div class="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">History</span>
            <span id="request-count" class="text-xs font-mono text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700/50">
                {{ .TotalCount }}
            </span>
        </div>
        <ul id="request-list" class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-slate-800/50">
            {{ range .Requests }}
                {{ template "request-item" . }}
            {{ end }}
            {{ if .HasMore }}
            <li id="load-more-container" class="p-4 text-center">
                <button hx-get="/{{ .Endpoint.ID }}/more?offset={{ len .Requests }}&limit={{ .Limit }}"
                        hx-target="#load-more-container"
                        hx-swap="outerHTML"
                        class="text-xs font-bold text-brand-400 hover:text-brand-300 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg transition-all">
                    <i class="fas fa-chevron-down mr-2"></i>Load More ({{ if gt (sub .TotalCount (len .Requests)) 0 }}{{ sub .TotalCount (len .Requests) }}{{ else }}0{{ end }} remaining)
                </button>
            </li>
            {{ end }}
        </ul>
    </div>

    <!-- Details Area -->
    <div class="flex-1 flex flex-col min-w-0 bg-slate-950">
        <!-- Endpoint Header -->
        <div id="endpoint-header" class="p-4 border-b border-slate-800 flex items-center justify-between gap-4 bg-slate-900/20" data-endpoint-id="{{ if .Endpoint }}{{ .Endpoint.ID }}{{ end }}">
            <div class="flex items-center gap-4 min-w-0 flex-1">
                <a href="/" class="text-xs text-slate-500 hover:text-brand-400 transition-colors flex items-center gap-1.5 shrink-0" title="View all endpoints">
                    <i class="fas fa-arrow-left text-[10px]"></i>
                    <span>All</span>
                </a>
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <span class="text-xs text-slate-500 font-semibold whitespace-nowrap uppercase tracking-wider shrink-0">URL</span>
                    {{ if .Endpoint }}
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <div id="endpoint-color-dot" class="w-2 h-2 rounded-full shrink-0 bg-brand-500"></div>
                        <code id="endpoint-url" class="bg-slate-900 border border-slate-800 text-brand-400 px-3 py-1 rounded text-sm font-mono truncate select-all shadow-inner flex-1 min-w-0" data-url="https://{{ .Host }}/h/{{ .Endpoint.ID }}">https://{{ .Host }}/h/{{ .Endpoint.ID }}</code>
                    </div>
                    <button onclick="copyEndpointUrl()" class="text-slate-500 hover:text-white transition-colors p-1.5 hover:bg-slate-800 rounded-md shrink-0">
                        <i class="fas fa-copy text-xs"></i>
                    </button>
                    {{ else }}
                    <code class="bg-slate-900 border border-slate-800 text-slate-500 px-3 py-1 rounded text-sm font-mono truncate select-all shadow-inner flex-1 min-w-0">Loading...</code>
                    {{ end }}
                </div>
            </div>
            <div class="flex items-center gap-3 whitespace-nowrap">
                {{ if .OtherEndpoints }}
                <div class="relative" id="switch-container">
                    <button id="switch-btn" onclick="toggleSwitchDropdown()" class="text-xs font-bold text-slate-300 hover:text-white bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1.5">
                        <i class="fas fa-exchange-alt text-[10px]"></i>
                        Switch
                        <i id="switch-chevron" class="fas fa-chevron-down text-[8px] transition-transform duration-200"></i>
                    </button>
                    <div id="switch-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-slate-900 border border-slate-800 rounded-lg shadow-xl py-1 z-50">
                        {{ range .OtherEndpoints }}
                        <a href="/{{ .ID }}" class="block px-4 py-2 text-[10px] font-mono text-slate-400 hover:text-white hover:bg-slate-800 truncate flex items-center gap-2 border-l-4 switch-endpoint-item" data-endpoint-id="{{ .ID }}">
                            <div class="w-1.5 h-1.5 rounded-full shrink-0 switch-endpoint-dot" data-endpoint-id="{{ .ID }}"></div>
                            <span class="truncate">{{ .ID }}</span>
                        </a>
                        {{ end }}
                        <div class="border-t border-slate-800 mt-1 pt-1">
                            <a href="/" class="block px-4 py-2 text-[10px] text-brand-400 hover:text-brand-300 hover:bg-slate-800">
                                <i class="fas fa-plus text-[8px] mr-2"></i>Create New
                            </a>
                        </div>
                    </div>
                </div>
                {{ end }}
                <span class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    Live Stream
                </span>
                {{ if .Endpoint }}
                <button onclick="openSettingsModal()" class="text-xs font-bold text-slate-300 hover:text-white bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg transition-all active:scale-95 flex items-center gap-1.5">
                    <i class="fas fa-cog text-[10px]"></i>
                    Settings
                </button>
                <button class="text-xs font-bold text-white bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded-lg transition-all active:scale-95 flex items-center gap-1.5 shadow-lg shadow-red-600/10"
                        data-endpoint-id="{{ .Endpoint.ID }}"
                        hx-delete="/endpoint/{{ .Endpoint.ID }}"
                        hx-confirm="Are you sure you want to delete this webhook endpoint? All requests will be deleted."
                        hx-target="body"
                        hx-swap="none"
                        hx-on::after-request="handleDeleteEndpoint(this)">
                    <i class="fas fa-trash-can text-[10px]"></i>
                    Delete
                </button>
                {{ end }}
            </div>
        </div>

        <!-- Request Detail Placeholder/Content -->
        <div id="request-detail" class="flex-1 overflow-hidden flex flex-col relative transition-opacity duration-150">
            <!-- Loading overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm z-10 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200" style="display: none;">
                <div class="text-center">
                    <div class="w-8 h-8 border-2 border-brand-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-xs text-slate-400">Loading...</p>
                </div>
            </div>
            <!-- Content wrapper -->
            <div id="request-detail-content" class="flex-1 overflow-hidden flex flex-col transition-opacity duration-200 ease-in-out">
                {{ if .FirstRequest }}
                    {{ template "request-detail" .FirstRequest }}
                {{ else }}
                    <div class="flex-1 flex flex-col items-center justify-center text-slate-600 p-8 text-center bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900/50 to-transparent">
                        <div class="w-16 h-16 bg-slate-900 border border-slate-800 rounded-2xl flex items-center justify-center mb-6 text-slate-700 shadow-xl opacity-20">
                            <img src="/static/pipehook.svg" class="w-10 h-10 grayscale" alt="PipeHooks">
                        </div>
                        <p class="text-sm font-medium text-slate-500">Waiting for activity on endpoint...</p>
                        <p class="text-xs text-slate-600 mt-2">Send an HTTP request to the URL above to see it here.</p>
                    </div>
                {{ end }}
            </div>
        </div>
    </div>
</div>

    <script>
        (function() {
            // Loading overlay helpers
            function showLoadingOverlay() {
                var overlay = document.getElementById("loading-overlay");
                var content = document.getElementById("request-detail-content");
                if (overlay) {
                    overlay.style.display = "flex";
                    setTimeout(function() { overlay.style.opacity = "1"; }, 10);
                }
                if (content) {
                    content.style.opacity = "0.4";
                }
            }
            function hideLoadingOverlay() {
                var overlay = document.getElementById("loading-overlay");
                var content = document.getElementById("request-detail-content");
                if (overlay) {
                    overlay.style.opacity = "0";
                    setTimeout(function() { overlay.style.display = "none"; }, 200);
                }
                if (content) {
                    content.style.opacity = "1";
                }
            }
            window.showLoadingOverlay = showLoadingOverlay;
            window.hideLoadingOverlay = hideLoadingOverlay;

            // Switch dropdown toggle (plain JavaScript)
            var switchDropdownOpen = false;
            function toggleSwitchDropdown() {
                var dropdown = document.getElementById("switch-dropdown");
                var chevron = document.getElementById("switch-chevron");
                switchDropdownOpen = !switchDropdownOpen;
                if (dropdown) {
                    if (switchDropdownOpen) {
                        dropdown.classList.remove("hidden");
                    } else {
                        dropdown.classList.add("hidden");
                    }
                }
                if (chevron) {
                    if (switchDropdownOpen) {
                        chevron.classList.add("rotate-180");
                    } else {
                        chevron.classList.remove("rotate-180");
                    }
                }
            }
            window.toggleSwitchDropdown = toggleSwitchDropdown;

            // Close dropdown when clicking outside
            document.addEventListener("click", function(event) {
                var container = document.getElementById("switch-container");
                if (container && !container.contains(event.target) && switchDropdownOpen) {
                    switchDropdownOpen = false;
                    var dropdown = document.getElementById("switch-dropdown");
                    var chevron = document.getElementById("switch-chevron");
                    if (dropdown) dropdown.classList.add("hidden");
                    if (chevron) chevron.classList.remove("rotate-180");
                }
            });

            // Set endpoint color on load
            {{ if .Endpoint }}
            (function() {
                var endpointIdElement = document.getElementById("endpoint-header");
                if(endpointIdElement && typeof getEndpointColor === "function") {
                    var endpointId = endpointIdElement.getAttribute("data-endpoint-id");
                    if(endpointId) {
                        var endpointColor = getEndpointColor(endpointId);
                        if (endpointColor) {
                            var header = document.getElementById("endpoint-header");
                            var dot = document.getElementById("endpoint-color-dot");
                            var url = document.getElementById("endpoint-url");
                            if (header) {
                                header.classList.add("border-l-4", endpointColor.border);
                                header.classList.remove("border-slate-800");
                            }
                            if (dot) {
                                dot.classList.remove("bg-brand-500");
                                dot.classList.add(endpointColor.accent);
                            }
                            if (url) {
                                url.classList.remove("text-brand-400");
                                url.classList.add(endpointColor.text);
                            }
                        }
                    }
                }
            })();
            {{ end }}

            // Handle HTMX events for smooth transitions
            document.body.addEventListener("htmx:beforeRequest", function(e) {
                if (e.detail.target && e.detail.target.id === "request-detail-content") {
                    showLoadingOverlay();
                }
            });

            document.body.addEventListener("htmx:afterSwap", function(e) {
                if (e.detail.target && e.detail.target.id === "request-detail-content") {
                    hideLoadingOverlay();
                    if (typeof initRequestDetail === "function") {
                        initRequestDetail();
                    }
                }
            });

            document.body.addEventListener("htmx:responseError", function(e) {
                hideLoadingOverlay();
            });

            document.body.addEventListener("htmx:sendError", function(e) {
                hideLoadingOverlay();
            });

            // Copy endpoint URL function
            function copyEndpointUrl() {
                const urlElement = document.getElementById("endpoint-url");
                if(urlElement) {
                    const url = urlElement.getAttribute("data-url");
                    if(url) {
                        navigator.clipboard.writeText(url).then(() => {
                            if(typeof showToast === "function") {
                                showToast("URL copied", "success");
                            }
                        }).catch(() => {});
                    }
                }
            }
            window.copyEndpointUrl = copyEndpointUrl;

            // Set delete endpoint URL before request
            function setDeleteEndpointUrl(button) {
                const endpointId = button ? button.getAttribute("data-endpoint-id") : null;
                if(endpointId) {
                    button.setAttribute("hx-delete", "/endpoint/" + endpointId);
                }
            }
            window.setDeleteEndpointUrl = setDeleteEndpointUrl;

            // Handle delete endpoint
            function handleDeleteEndpoint(button) {
                if(typeof event !== "undefined" && event.detail && event.detail.xhr && event.detail.xhr.status === 200) {
                    window.location.href = "/";
                }
            }
            window.handleDeleteEndpoint = handleDeleteEndpoint;

            // Handle request item click
            function handleRequestItemClick(element) {
                // Find the li element (could be the element itself or a parent)
                var li = element.closest("li");
                if (!li) return;

                // Remove active state from all items
                document.querySelectorAll("#request-list li").forEach(function(el) {
                    el.classList.remove("bg-slate-800/50", "shadow-inner", "border-l-brand-500");
                    el.classList.add("border-l-transparent");
                });

                // Add active state to clicked item
                li.classList.add("bg-slate-800/50", "shadow-inner");
                li.classList.remove("border-l-transparent");

                // Apply endpoint color for the active border
                var endpointId = li.getAttribute("data-endpoint-id");
                if (endpointId && typeof getEndpointColor === "function") {
                    var color = getEndpointColor(endpointId);
                    if (color) {
                        li.classList.add(color.border);
                    }
                }
            }
            window.handleRequestItemClick = handleRequestItemClick;

            // Set request detail URL before request
            function setRequestDetailUrl(element) {
                const requestId = element ? element.getAttribute("data-request-id") : null;
                if(requestId) {
                    element.setAttribute("hx-get", "/r/" + requestId);
                }
            }
            window.setRequestDetailUrl = setRequestDetailUrl;

            // Set delete request URL before request
            function setDeleteRequestUrl(button) {
                const requestId = button ? button.getAttribute("data-request-id") : null;
                if(requestId) {
                    button.setAttribute("hx-delete", "/r/" + requestId);
                }
            }
            window.setDeleteRequestUrl = setDeleteRequestUrl;

            // Handle delete request from list
            function handleDeleteRequestFromList(button) {
                if(typeof event !== "undefined" && event.detail && event.detail.xhr && event.detail.xhr.status === 200) {
                    const listItem = button.closest("li");
                    if(listItem) {
                        listItem.remove();
                        const count = document.getElementById("request-count");
                        if(count) {
                            const current = parseInt(count.innerText) || 0;
                            count.innerText = Math.max(0, current - 1);
                        }
                    }
                }
            }
            window.handleDeleteRequestFromList = handleDeleteRequestFromList;

            // ============================================
            // Request Detail Functions (from request-detail.html)
            // ============================================

            function setReplayUrl(button) {
                var requestId = button ? button.getAttribute("data-request-id") : null;
                if(requestId) {
                    button.setAttribute("hx-post", "/r/" + requestId + "/replay");
                }
            }
            window.setReplayUrl = setReplayUrl;

            function handleReplayBefore(button) {
                if(button) {
                    button.classList.add("opacity-50", "pointer-events-none");
                    var icon = button.querySelector("i");
                    if(icon) icon.classList.add("animate-spin");
                }
            }
            window.handleReplayBefore = handleReplayBefore;

            function handleReplayAfter(button) {
                if(button) {
                    button.classList.remove("opacity-50", "pointer-events-none");
                    var icon = button.querySelector("i");
                    if(icon) icon.classList.remove("animate-spin");
                }
                if (typeof showToast === "function") {
                    showToast("Request replayed", "success");
                }
            }
            window.handleReplayAfter = handleReplayAfter;

            function handleDeleteRequest(button) {
                if(typeof event !== "undefined" && event.detail && event.detail.xhr && event.detail.xhr.status === 200) {
                    var requestId = button.getAttribute("data-request-id");
                    var endpointId = button.getAttribute("data-endpoint-id");
                    if(requestId) {
                        var selector = "[data-request-id=" + String.fromCharCode(34) + requestId + String.fromCharCode(34) + "]";
                        var listItem = document.querySelector(selector);
                        if(listItem) listItem.remove();
                    }
                    var count = document.getElementById("request-count");
                    if(count) {
                        var current = parseInt(count.innerText) || 0;
                        count.innerText = Math.max(0, current - 1);
                    }
                    if(typeof showToast === "function") {
                        showToast("Request deleted", "success");
                    }
                    if(endpointId) {
                        window.location.href = "/" + endpointId;
                    }
                }
            }
            window.handleDeleteRequest = handleDeleteRequest;

            function toggleSection(sectionId) {
                var section = document.getElementById(sectionId);
                var chevronId = sectionId.replace("-section", "-chevron");
                var chevron = document.getElementById(chevronId);
                if (section && chevron) {
                    var isHidden = section.classList.contains("hidden");
                    if (isHidden) {
                        section.classList.remove("hidden");
                        chevron.classList.remove("rotate-180");
                    } else {
                        section.classList.add("hidden");
                        chevron.classList.add("rotate-180");
                    }
                }
            }
            window.toggleSection = toggleSection;

            var headersViewMode = "json";

            function toggleHeadersView() {
                var jsonView = document.getElementById("headers-json-view");
                var listView = document.getElementById("headers-list-view");
                var toggleBtn = document.getElementById("headers-view-toggle");
                if (!jsonView || !listView || !toggleBtn) return;
                if (headersViewMode === "json") {
                    jsonView.classList.add("hidden");
                    listView.classList.remove("hidden");
                    toggleBtn.innerHTML = "<i class=" + String.fromCharCode(34) + "fas fa-list-ul text-xs" + String.fromCharCode(34) + "></i>";
                    headersViewMode = "list";
                } else {
                    jsonView.classList.remove("hidden");
                    listView.classList.add("hidden");
                    toggleBtn.innerHTML = "<i class=" + String.fromCharCode(34) + "fas fa-code text-xs" + String.fromCharCode(34) + "></i>";
                    headersViewMode = "json";
                }
            }
            window.toggleHeadersView = toggleHeadersView;

            function copyHeaders() {
                var jsonView = document.getElementById("headers-json-view");
                var listView = document.getElementById("headers-list-view");
                var activeView = headersViewMode === "json" ? jsonView : listView;
                if (!activeView) return;
                var text = activeView.innerText || activeView.textContent || "";
                navigator.clipboard.writeText(text).then(function() {
                    if (typeof showToast === "function") {
                        showToast("Headers copied", "success");
                    }
                }).catch(function() {
                    if (typeof showToast === "function") {
                        showToast("Failed to copy", "error");
                    }
                });
            }
            window.copyHeaders = copyHeaders;

            function copyBody() {
                var bodyRaw = document.getElementById("body-raw");
                if (!bodyRaw) {
                    if (typeof showToast === "function") {
                        showToast("Cannot copy binary content", "info");
                    }
                    return;
                }
                var text = bodyRaw.innerText || bodyRaw.textContent || "";
                navigator.clipboard.writeText(text).then(function() {
                    if (typeof showToast === "function") {
                        showToast("Body copied", "success");
                    }
                }).catch(function() {
                    if (typeof showToast === "function") {
                        showToast("Failed to copy", "error");
                    }
                });
            }
            window.copyBody = copyBody;

            function formatBody() {
                var bodyRaw = document.getElementById("body-raw");
                var lineNumbers = document.getElementById("line-numbers");
                if (!bodyRaw) return;
                var text = bodyRaw.textContent || bodyRaw.innerText || "";
                if (!text.trim()) return;
                try {
                    var json = JSON.parse(text);
                    var formatted = JSON.stringify(json, null, 2);
                    bodyRaw.textContent = formatted;
                    updateLineNumbers(bodyRaw, lineNumbers);
                    if (typeof showToast === "function") {
                        showToast("JSON formatted", "success");
                    }
                } catch (e) {
                    if (typeof showToast === "function") {
                        showToast("Not valid JSON", "error");
                    }
                }
            }
            window.formatBody = formatBody;

            function updateLineNumbers(bodyRaw, lineNumbers) {
                if (!bodyRaw || !lineNumbers) return;
                var text = bodyRaw.innerText || bodyRaw.textContent || "";
                var lines = text.split("\n");
                var html = "";
                for (var i = 0; i < lines.length; i++) {
                    html += "<div class=" + String.fromCharCode(34) + "leading-relaxed" + String.fromCharCode(34) + ">" + (i + 1) + "</div>";
                }
                lineNumbers.innerHTML = html;
            }

            function initRequestDetail() {
                var bodyRaw = document.getElementById("body-raw");
                var lineNumbers = document.getElementById("line-numbers");
                if (bodyRaw && lineNumbers) {
                    var text = bodyRaw.textContent || bodyRaw.innerText || "";
                    if (text.trim()) {
                        try {
                            var json = JSON.parse(text);
                            var formatted = JSON.stringify(json, null, 2);
                            bodyRaw.textContent = formatted;
                        } catch (e) {}
                    }
                    updateLineNumbers(bodyRaw, lineNumbers);
                }
                // Update headers line numbers too
                var headersRaw = document.getElementById("headers-raw");
                var headersLineNumbers = document.getElementById("headers-line-numbers");
                if (headersRaw && headersLineNumbers) {
                    updateLineNumbers(headersRaw, headersLineNumbers);
                }
            }
            window.initRequestDetail = initRequestDetail;

            // Initialize on page load if detail content exists
            initRequestDetail();

            // Auto-select first item if there's content displayed
            (function() {
                var firstItem = document.querySelector("#request-list li");
                var detailContent = document.getElementById("request-detail-content");
                if (firstItem && detailContent && detailContent.children.length > 0) {
                    // Check if detail content has actual content (not just the empty state)
                    var hasContent = !detailContent.querySelector(".text-slate-500");
                    if (hasContent || detailContent.innerHTML.indexOf("Waiting for activity") === -1) {
                        handleRequestItemClick(firstItem);
                    }
                }
            })();

            // ============================================
            // End Request Detail Functions
            // ============================================

            // Apply colors to request items and dropdown - only unprocessed elements
            function applyEndpointColors(container) {
                // Ensure we have a valid element with querySelectorAll
                var scope = (container && typeof container.querySelectorAll === "function") ? container : document;

                // Only process elements not yet colored (no data-colored attribute)
                var elements = scope.querySelectorAll("[data-endpoint-id]:not([data-colored])");
                for (var i = 0; i < elements.length; i++) {
                    var el = elements[i];
                    var endpointId = el.getAttribute("data-endpoint-id");
                    if (!endpointId) continue;

                    var color = getEndpointColor(endpointId);
                    if (!color) continue;

                    // Mark as processed to avoid re-processing
                    el.setAttribute("data-colored", "1");

                    // Apply border color based on element type
                    if (el.tagName === "LI" || el.classList.contains("switch-endpoint-item")) {
                        el.classList.add(color.border);
                    }

                    // Apply dot color
                    var dot = el.querySelector(".endpoint-color-dot, .switch-endpoint-dot");
                    if (dot && !dot.hasAttribute("data-colored")) {
                        dot.classList.add(color.accent);
                        dot.setAttribute("data-colored", "1");
                    }
                }
            }

            // Initial color application (deferred)
            requestAnimationFrame(function() { applyEndpointColors(document); });

            // Re-apply colors only to new content after HTMX swap
            document.body.addEventListener("htmx:afterSwap", function(e) {
                requestAnimationFrame(function() {
                    applyEndpointColors(e.detail && e.detail.target ? e.detail.target : document);
                });
            });

            // WebSocket connection for real-time updates
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const endpointIdElement = document.getElementById("endpoint-header");
            const endpointId = endpointIdElement ? endpointIdElement.getAttribute("data-endpoint-id") : null;
            console.log("WebSocket setup - endpointId:", endpointId);
            if(endpointId) {
                const wsUrl = protocol + "//" + window.location.host + "/ws/" + endpointId;
                console.log("Connecting WebSocket to:", wsUrl);
                const ws = new WebSocket(wsUrl);
                const requestList = document.getElementById("request-list");
                const requestCount = document.getElementById("request-count");

                var MAX_DOM_ITEMS = 200; // Limit DOM elements to prevent memory bloat

                ws.onopen = function() {
                    console.log("WebSocket connected successfully");
                };

                ws.onmessage = function(event) {
                    console.log("WebSocket message received:", event.data);
                    var data = JSON.parse(event.data);
                    if (data.type === "new-request") {
                        // Create element from HTML string
                        var temp = document.createElement("div");
                        temp.innerHTML = data.payload;
                        var newItem = temp.firstElementChild;

                        if (newItem && requestList) {
                            // Insert at top
                            requestList.insertBefore(newItem, requestList.firstChild);

                            // Process HTMX attributes
                            if (typeof htmx !== "undefined") {
                                htmx.process(newItem);
                            }

                            // Apply color to new item only (not all items)
                            var endpointId = newItem.getAttribute("data-endpoint-id");
                            if (endpointId && typeof getEndpointColor === "function") {
                                var color = getEndpointColor(endpointId);
                                if (color) {
                                    var dot = newItem.querySelector(".endpoint-color-dot");
                                    if (dot) dot.classList.add(color.accent);
                                }
                            }

                            // Update count
                            if (requestCount) {
                                var current = parseInt(requestCount.innerText) || 0;
                                requestCount.innerText = current + 1;
                            }

                            // Update time on new item only
                            var timeEl = newItem.querySelector("[data-timestamp]");
                            if (timeEl && typeof formatTimeAgo === "function") {
                                var ts = timeEl.getAttribute("data-timestamp");
                                if (ts) timeEl.innerText = formatTimeAgo(ts);
                            }

                            // Prune old items to prevent DOM bloat
                            var items = requestList.querySelectorAll("li[data-request-id]");
                            if (items.length > MAX_DOM_ITEMS) {
                                for (var i = MAX_DOM_ITEMS; i < items.length; i++) {
                                    items[i].remove();
                                }
                            }
                        }
                        // Clean up temp element
                        temp = null;
                    }
                };

                ws.onerror = function(error) {
                    console.error("WebSocket error:", error);
                };

                ws.onclose = function() {
                    console.log("WebSocket connection closed");
                };

                // Clean up WebSocket when leaving page
                window.addEventListener("beforeunload", function() {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.close();
                    }
                });

                // Pause updates when tab is hidden to save resources
                document.addEventListener("visibilitychange", function() {
                    if (document.hidden && ws && ws.readyState === WebSocket.OPEN) {
                        // Could pause, but WebSocket is lightweight - just log
                        console.log("Tab hidden, WebSocket still connected");
                    }
                });
            }
        })();

        // Settings Modal Functions
        function openSettingsModal() {
            var modal = document.getElementById("settings-modal");
            if (modal) {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
                document.body.style.overflow = "hidden";
            }
        }
        window.openSettingsModal = openSettingsModal;

        function closeSettingsModal() {
            var modal = document.getElementById("settings-modal");
            if (modal) {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
                document.body.style.overflow = "";
            }
        }
        window.closeSettingsModal = closeSettingsModal;

        // Close modal when clicking outside
        document.addEventListener("click", function(event) {
            var modal = document.getElementById("settings-modal");
            if (modal && event.target === modal) {
                closeSettingsModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener("keydown", function(event) {
            if (event.key === "Escape") {
                closeSettingsModal();
            }
        });
    </script>

    {{ if .Endpoint }}
    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 items-center justify-center">
        <div class="bg-slate-900 border border-slate-800 rounded-xl shadow-2xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
                <h3 class="text-lg font-bold text-white">Endpoint Settings</h3>
                <button onclick="closeSettingsModal()" class="text-slate-500 hover:text-white transition-colors p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form hx-post="/endpoint/{{ .Endpoint.ID }}/settings" hx-swap="none" class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Alias (optional)</label>
                    <input type="text" name="alias" value="{{ .Endpoint.Alias }}"
                           placeholder="e.g., My Payment Webhook"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                    <p class="text-xs text-slate-500 mt-1.5">Give your endpoint a friendly name</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Expiration</label>
                    <select name="ttl" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500">
                        <option value="1week">1 Week</option>
                        <option value="1month">1 Month</option>
                        <option value="3months" selected>3 Months (Default)</option>
                        <option value="6months">6 Months</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1.5">How long this endpoint will remain active</p>
                    <p class="text-xs text-slate-400 mt-2 bg-slate-800/50 px-3 py-2 rounded-lg">
                        <i class="fas fa-info-circle text-brand-400 mr-1"></i>
                        Created: {{ .Endpoint.CreatedAt.Format "Jan 2, 2006" }} Â·
                        Expires: {{ .Endpoint.ExpiresAt.Format "Jan 2, 2006" }}
                    </p>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeSettingsModal()" class="flex-1 px-4 py-2.5 text-sm font-semibold text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2.5 text-sm font-bold text-white bg-brand-600 hover:bg-brand-500 rounded-lg transition-colors shadow-lg shadow-brand-600/20">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    {{ end }}
{{ end }}

{{ define "request-item" }}
<li class="group hover:bg-slate-800/40 cursor-pointer transition-all border-l-4 border-l-transparent"
    data-request-id="{{ .ID }}"
    data-endpoint-id="{{ .EndpointID }}"
    hx-get="/r/{{ .ID }}"
    hx-target="#request-detail-content"
    hx-swap="innerHTML"
    onclick="handleRequestItemClick(this)">
    <div class="px-4 py-3 flex items-start justify-between gap-2">
        <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-1.5">
                    <span class="endpoint-color-dot w-1.5 h-1.5 rounded-full shrink-0"></span>
                    <span class="text-xs font-bold {{ if eq .Method "GET" }}text-emerald-500{{ else }}text-brand-400{{ end }} font-mono">{{ .Method }}</span>
                </div>
                <span class="text-[10px] text-slate-500 font-mono" data-timestamp="{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}">{{ .CreatedAt.Format "15:04:05" }}</span>
            </div>
            <p class="text-xs text-slate-300 font-mono truncate">{{ .Path }}</p>
            <p class="text-[10px] text-slate-600 font-mono truncate">{{ .RemoteAddr }}</p>
        </div>
        <button class="opacity-0 group-hover:opacity-100 text-slate-600 hover:text-red-500 p-1"
                hx-delete="/r/{{ .ID }}"
                hx-target="closest li"
                hx-swap="outerHTML"
                hx-on::after-request="handleDeleteRequestFromList(this)"
                onclick="event.stopPropagation();">
            <i class="fas fa-trash-can text-[10px]"></i>
        </button>
    </div>
</li>
{{ end }}
