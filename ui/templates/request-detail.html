{{ define "request-detail" }}
<div class="flex flex-col h-full overflow-hidden">
    <!-- Compact Header -->
    <div class="px-6 py-4 border-b border-slate-800 bg-slate-900/40 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-4 min-w-0">
            <span class="text-sm font-bold {{ if eq .Method "GET" }}text-emerald-500{{ else }}text-brand-400{{ end }} font-mono bg-slate-900/50 px-2 py-1 rounded border border-slate-800/50">{{ .Method }}</span>
            <span class="text-sm text-slate-200 font-mono truncate max-w-2xl">{{ .Path }}</span>
        </div>
        <div class="flex items-center gap-2">
            <button class="text-xs font-bold text-white bg-brand-600 hover:bg-brand-500 px-4 py-2 rounded-lg transition-all active:scale-95 flex items-center gap-2 shadow-lg shadow-brand-600/10"
                    hx-post="/r/{{ .ID }}/replay"
                    hx-swap="none"
                    hx-on::before-request="this.classList.add('opacity-50', 'pointer-events-none'); this.querySelector('i').classList.add('animate-spin')"
                    hx-on::after-request="this.classList.remove('opacity-50', 'pointer-events-none'); this.querySelector('i').classList.remove('animate-spin')">
                <i class="fas fa-repeat text-[10px]"></i>
                Replay
            </button>
            <button class="text-xs font-bold text-white bg-red-600 hover:bg-red-500 px-4 py-2 rounded-lg transition-all active:scale-95 flex items-center gap-2 shadow-lg shadow-red-600/10"
                    hx-delete="/r/{{ .ID }}"
                    hx-confirm="Are you sure you want to delete this request?"
                    hx-target="body"
                    hx-swap="none"
                    hx-on::after-request="if(event.detail.xhr.status === 200) { window.location.href = '/{{ .EndpointID }}'; }">
                <i class="fas fa-trash-can text-[10px]"></i>
                Delete
            </button>
        </div>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
        <!-- Headers -->
        <div>
            <div class="flex items-center justify-between mb-3">
                <button onclick="toggleSection('headers-section')" class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2 hover:text-slate-400 transition-colors">
                    <i class="fas fa-list-ul text-[10px]"></i>
                    Headers
                    <i id="headers-chevron" class="fas fa-chevron-down text-[8px] transition-transform"></i>
                </button>
                <button onclick="navigator.clipboard.writeText(document.getElementById('headers-raw').innerText)" class="text-slate-600 hover:text-brand-400 transition-colors p-1 rounded hover:bg-slate-800">
                    <i class="far fa-copy text-xs"></i>
                </button>
            </div>
            <div id="headers-section" class="bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden shadow-inner">
                <table class="w-full text-left text-xs font-mono">
                    <tbody id="headers-raw">
                        {{ range $key, $values := .HeadersMap }}
                        <tr class="border-b border-slate-800/30 last:border-0 hover:bg-slate-800/40 transition-colors">
                            <td class="py-2.5 px-4 text-slate-500 w-1/4 border-r border-slate-800/30 font-semibold">{{ $key }}</td>
                            <td class="py-2.5 px-4 text-brand-300 break-all">{{ index $values 0 }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Body -->
        <div>
            <div class="flex items-center justify-between mb-3">
                <button onclick="toggleSection('body-section')" class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2 hover:text-slate-400 transition-colors">
                    <i class="fas fa-code text-[10px]"></i>
                    Payload Body
                    <i id="body-chevron" class="fas fa-chevron-down text-[8px] transition-transform"></i>
                </button>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-slate-600 bg-slate-900/50 border border-slate-800 px-2 py-0.5 rounded font-mono">{{ len .Body }} bytes</span>
                    <button onclick="formatBody()" class="text-slate-600 hover:text-brand-400 transition-colors p-1 rounded hover:bg-slate-800" title="Format JSON">
                        <i class="fas fa-indent text-xs"></i>
                    </button>
                    <button onclick="navigator.clipboard.writeText(document.getElementById('body-raw').innerText)" class="text-slate-600 hover:text-brand-400 transition-colors p-1 rounded hover:bg-slate-800">
                        <i class="far fa-copy text-xs"></i>
                    </button>
                </div>
            </div>
            <div id="body-section" class="bg-slate-950 border border-slate-800 rounded-xl overflow-hidden shadow-xl">
                <!-- Editor Header Bar -->
                <div class="bg-slate-900 border-b border-slate-800 px-4 py-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500/60"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/60"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-emerald-500/60"></div>
                        </div>
                        <span class="text-[10px] text-slate-500 font-mono ml-2">body</span>
                    </div>
                </div>
                <!-- Code Editor Content -->
                <div class="relative overflow-auto max-h-[500px] custom-scrollbar">
                    <div class="flex">
                        <!-- Line Numbers -->
                        <div id="line-numbers" class="bg-slate-900/80 text-slate-600 text-[11px] font-mono py-3 px-3 text-right select-none border-r border-slate-800/50 sticky left-0"></div>
                        <!-- Code Content -->
                        <pre id="body-raw" class="flex-1 text-[11px] font-mono py-3 px-4 m-0 leading-relaxed whitespace-pre overflow-x-auto">{{ if .BodyString }}{{ .BodyString }}{{ else }}<span class="text-slate-600 italic">Empty body</span>{{ end }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const chevron = document.getElementById(sectionId.replace('-section', '-chevron'));
                if (section && chevron) {
                    const isHidden = section.classList.contains('hidden');
                    if (isHidden) {
                        section.classList.remove('hidden');
                        chevron.classList.remove('rotate-180');
                    } else {
                        section.classList.add('hidden');
                        chevron.classList.add('rotate-180');
                    }
                }
            }
            window.toggleSection = toggleSection;

            const bodyRaw = document.getElementById('body-raw');
            const lineNumbers = document.getElementById('line-numbers');
            let isJSON = false;

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function highlightJSON(text) {
                if (!isJSON) return escapeHtml(text);

                // Escape HTML first
                text = escapeHtml(text);

                // Highlight JSON syntax
                return text
                    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
                        let cls = 'text-slate-200';
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'text-brand-400'; // key
                            } else {
                                cls = 'text-emerald-400'; // string value
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'text-purple-400'; // boolean
                        } else if (/null/.test(match)) {
                            cls = 'text-slate-500'; // null
                        } else {
                            cls = 'text-blue-400'; // number
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    })
                    .replace(/([{}[\],:])/g, '<span class="text-slate-400">$1</span>');
            }

            function updateLineNumbers() {
                const text = bodyRaw.innerText || bodyRaw.textContent || '';
                const lines = text.split('\n');
                lineNumbers.innerHTML = lines.map((_, i) => `<div class="leading-relaxed">${i + 1}</div>`).join('');
            }

            function formatAndHighlight() {
                const originalText = bodyRaw.textContent || bodyRaw.innerText || '';
                if (!originalText.trim()) return;

                try {
                    const json = JSON.parse(originalText);
                    const formatted = JSON.stringify(json, null, 2);
                    bodyRaw.innerHTML = highlightJSON(formatted);
                    isJSON = true;
                    updateLineNumbers();
                } catch (e) {
                    // Not JSON, keep as is
                    bodyRaw.textContent = originalText;
                    isJSON = false;
                    updateLineNumbers();
                }
            }

            function formatBody() {
                const text = bodyRaw.textContent || bodyRaw.innerText || '';
                try {
                    const json = JSON.parse(text);
                    const formatted = JSON.stringify(json, null, 2);
                    bodyRaw.innerHTML = highlightJSON(formatted);
                    isJSON = true;
                    updateLineNumbers();
                } catch (e) {
                    if (typeof showToast === 'function') {
                        showToast('Not valid JSON', 'error');
                    } else {
                        alert('Not valid JSON');
                    }
                }
            }

            window.formatBody = formatBody;

            // Auto-format on load
            formatAndHighlight();
        })();
    </script>
    </div>
</div>
{{ end }}
